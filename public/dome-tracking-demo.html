<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Miyomi - Dome Performance Tracking Demo</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 40px;
      color: white;
    }

    h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
      font-weight: 700;
    }

    .subtitle {
      font-size: 1.1em;
      opacity: 0.9;
    }

    .demo-card {
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      margin-bottom: 20px;
    }

    .input-section {
      margin-bottom: 30px;
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #555;
    }

    input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      font-family: 'Monaco', 'Courier New', monospace;
    }

    input:focus {
      outline: none;
      border-color: #667eea;
    }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 14px 32px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      margin-right: 10px;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 30px;
    }

    .stat-card {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    }

    .stat-label {
      font-size: 0.9em;
      color: #666;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-value {
      font-size: 2em;
      font-weight: 700;
      color: #333;
    }

    .stat-value.positive {
      color: #10b981;
    }

    .stat-value.negative {
      color: #ef4444;
    }

    .orders-section {
      margin-top: 30px;
    }

    .orders-section h3 {
      margin-bottom: 20px;
      color: #333;
    }

    .order-card {
      background: #f8f9fa;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 12px;
      border-left: 4px solid #667eea;
    }

    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .order-title {
      font-weight: 600;
      color: #333;
      flex: 1;
    }

    .order-side {
      padding: 4px 12px;
      border-radius: 4px;
      font-size: 0.85em;
      font-weight: 600;
    }

    .order-side.buy {
      background: #d1fae5;
      color: #065f46;
    }

    .order-side.sell {
      background: #fee2e2;
      color: #991b1b;
    }

    .order-details {
      display: flex;
      gap: 20px;
      font-size: 0.9em;
      color: #666;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #667eea;
    }

    .error {
      background: #fee2e2;
      color: #991b1b;
      padding: 16px;
      border-radius: 8px;
      margin-top: 20px;
    }

    .info-box {
      background: #dbeafe;
      border-left: 4px solid #3b82f6;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .info-box h4 {
      margin-bottom: 8px;
      color: #1e40af;
    }

    .info-box p {
      color: #1e3a8a;
      line-height: 1.6;
    }

    .sample-wallets {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .sample-wallet-btn {
      background: #e0e7ff;
      color: #4338ca;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.85em;
      cursor: pointer;
      border: none;
      transition: background 0.2s;
    }

    .sample-wallet-btn:hover {
      background: #c7d2fe;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üîÆ Miyomi Performance Tracker</h1>
      <p class="subtitle">Powered by Dome API - Real-time prediction market analytics</p>
    </header>

    <div class="demo-card">
      <div class="info-box">
        <h4>üìä How This Works</h4>
        <p>
          This demo shows how Miyomi will track performance using the Dome API.
          Enter any Polymarket wallet address to see their trading history, P&L, and win rate.
          Once Miyomi starts trading, we'll track her wallet here automatically.
        </p>
        <div class="sample-wallets">
          <button class="sample-wallet-btn" onclick="loadSampleWallet('0x8ae2e93ead25c5d41e5f1b3c209c552cf7eb325d')">
            Try Sample Wallet
          </button>
        </div>
      </div>

      <div class="input-section">
        <label for="wallet">Wallet Address (Polymarket)</label>
        <input
          type="text"
          id="wallet"
          placeholder="0x..."
          value=""
        >
      </div>

      <button id="trackBtn" onclick="trackWallet()">
        Track Performance
      </button>
      <button onclick="location.reload()">
        Reset
      </button>

      <div id="results"></div>
    </div>
  </div>

  <script>
    const DOME_API_KEY = '42cd462b-625e-4b8b-b20c-ba6527f40259';
    const DOME_API_BASE = 'https://api.domeapi.io/v1';

    function loadSampleWallet(address) {
      document.getElementById('wallet').value = address;
      trackWallet();
    }

    async function trackWallet() {
      const wallet = document.getElementById('wallet').value.trim();
      const resultsDiv = document.getElementById('results');
      const trackBtn = document.getElementById('trackBtn');

      if (!wallet) {
        alert('Please enter a wallet address');
        return;
      }

      // Validate address format
      if (!wallet.startsWith('0x') || wallet.length !== 42) {
        alert('Please enter a valid Ethereum wallet address (0x...)');
        return;
      }

      trackBtn.disabled = true;
      resultsDiv.innerHTML = '<div class="loading">‚è≥ Fetching data from Dome API...</div>';

      try {
        // Step 1: Get order history
        const ordersResponse = await fetch(
          `${DOME_API_BASE}/polymarket/orders?user=${wallet}&limit=100`,
          {
            headers: {
              'Authorization': `Bearer ${DOME_API_KEY}`
            }
          }
        );

        if (!ordersResponse.ok) {
          throw new Error(`API Error: ${ordersResponse.status}`);
        }

        const ordersData = await ordersResponse.json();
        const orders = ordersData.orders || [];

        if (orders.length === 0) {
          resultsDiv.innerHTML = `
            <div class="info-box">
              <h4>No Trading History Found</h4>
              <p>This wallet hasn't made any trades on Polymarket yet, or the address is incorrect.</p>
            </div>
          `;
          trackBtn.disabled = false;
          return;
        }

        // Step 2: Calculate P&L
        const pnl = calculatePnL(orders);

        // Step 3: Display results
        displayResults(wallet, orders, pnl);

      } catch (error) {
        console.error('Error:', error);
        resultsDiv.innerHTML = `
          <div class="error">
            <strong>Error:</strong> ${error.message}
          </div>
        `;
      }

      trackBtn.disabled = false;
    }

    function calculatePnL(orders) {
      const marketPositions = {};

      // Group orders by market
      for (const order of orders) {
        const key = order.market_slug || order.condition_id;
        if (!marketPositions[key]) {
          marketPositions[key] = {
            market_slug: order.market_slug,
            title: order.title,
            buys: [],
            sells: []
          };
        }

        if (order.side === 'BUY') {
          marketPositions[key].buys.push(order);
        } else {
          marketPositions[key].sells.push(order);
        }
      }

      // Calculate P&L for each market
      let totalPnL = 0;
      let wins = 0;
      let losses = 0;

      for (const [market, position] of Object.entries(marketPositions)) {
        const totalBought = position.buys.reduce((sum, b) =>
          sum + (b.shares_normalized || b.shares) * b.price, 0
        );
        const totalSold = position.sells.reduce((sum, s) =>
          sum + (s.shares_normalized || s.shares) * s.price, 0
        );
        const pnl = totalSold - totalBought;

        if (pnl > 0) wins++;
        if (pnl < 0) losses++;

        totalPnL += pnl;
      }

      const tradesCount = wins + losses;
      const winRate = tradesCount > 0 ? (wins / tradesCount) * 100 : 0;

      return {
        total_pnl: totalPnL,
        win_rate: winRate,
        trades_count: tradesCount,
        wins,
        losses,
        markets_traded: Object.keys(marketPositions).length
      };
    }

    function displayResults(wallet, orders, pnl) {
      const pnlClass = pnl.total_pnl >= 0 ? 'positive' : 'negative';
      const pnlSign = pnl.total_pnl >= 0 ? '+' : '';

      const resultsHTML = `
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Total P&L</div>
            <div class="stat-value ${pnlClass}">
              ${pnlSign}$${Math.abs(pnl.total_pnl).toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
              })}
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-label">Win Rate</div>
            <div class="stat-value ${pnl.win_rate >= 50 ? 'positive' : 'negative'}">
              ${pnl.win_rate.toFixed(1)}%
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-label">Total Trades</div>
            <div class="stat-value">${pnl.trades_count}</div>
          </div>

          <div class="stat-card">
            <div class="stat-label">Markets</div>
            <div class="stat-value">${pnl.markets_traded}</div>
          </div>

          <div class="stat-card">
            <div class="stat-label">Wins</div>
            <div class="stat-value positive">${pnl.wins}</div>
          </div>

          <div class="stat-card">
            <div class="stat-label">Losses</div>
            <div class="stat-value negative">${pnl.losses}</div>
          </div>
        </div>

        <div class="orders-section">
          <h3>üìã Recent Orders (Last ${Math.min(orders.length, 10)})</h3>
          ${orders.slice(0, 10).map(order => `
            <div class="order-card">
              <div class="order-header">
                <div class="order-title">${order.title || 'Unknown Market'}</div>
                <div class="order-side ${order.side.toLowerCase()}">${order.side}</div>
              </div>
              <div class="order-details">
                <span>üí∞ ${(order.shares_normalized || order.shares).toFixed(2)} shares @ $${order.price.toFixed(3)}</span>
                <span>üìÖ ${new Date(order.timestamp * 1000).toLocaleDateString()}</span>
              </div>
            </div>
          `).join('')}
        </div>

        <div class="info-box" style="margin-top: 30px;">
          <h4>‚úÖ Dome API Status</h4>
          <p>
            <strong>Working:</strong> Order history, P&L calculation from orders<br>
            <strong>Coming Soon:</strong> Market prices, candlesticks, automated PnL endpoint<br>
            <strong>Data Source:</strong> Real-time from Polymarket via Dome API
          </p>
        </div>
      `;

      document.getElementById('results').innerHTML = resultsHTML;
    }
  </script>
</body>
</html>
